# =============================================================================
# Fuzzer Environment Configuration
# =============================================================================
# This file contains all environment variables for the AFL++ fuzzing harness.
# Source this file before running the fuzzer, or run.sh will load it automatically.
#
# Usage:
#   source fuzzer.env && afl/afl_picorv32 input.bin
#   OR
#   ./run.sh  (automatically sources this file)
#
# UI Mode:
#   Control AFL++ status screen display with --ui-mode flag in run.sh:
#   - auto (default): AFL++ auto-detects TTY and shows UI when appropriate
#   - on:             Force UI display (sets AFL_FORCE_UI=1)
#   - off:            Disable UI for logging/automation (sets AFL_NO_UI=1)
# =============================================================================

# ---------- Mutator Configuration ----------
# All mutator settings (strategy, enable_c, probabilities, weights) are now
# configured in the YAML file specified by MUTATOR_CONFIG
# Note: These paths are relative to PROJECT_ROOT (set by run.sh)
# If sourcing directly, ensure PROJECT_ROOT is set first
export MUTATOR_CONFIG="${PROJECT_ROOT:-$(pwd)}/afl/isa_mutator/config/mutator.default.yaml"
export SCHEMA_DIR="${PROJECT_ROOT:-$(pwd)}/schemas"             # ISA schema directory

# ---------- Debug Configuration ----------
# DEBUG controls detailed function tracing in the ISA mutator and harness:
# - When DEBUG=1: Enables detailed function entry/exit traces in runtime.log
# - When DEBUG=0: Only INFO/WARN/ERROR logs (no function tracing)
# 
# All logs (mutator + harness) are written to: workdir/logs/runtime.log
# This keeps AFL++ stdout/stderr clean for the fuzzer UI.
# 
# Note: AFL++ has its own separate debug flag (AFL_DEBUG) controlled by --afl-debug
export DEBUG="0"                        # Function tracing (0=off, 1=on)

# ---------- Harness Execution Limits ----------
export MAX_CYCLES="50000"               # Maximum CPU cycles per test case
export PC_STAGNATION_LIMIT="512"        # Max commits at same PC before timeout
export MAX_PROGRAM_WORDS="256"          # Maximum program size in 32-bit words

# ---------- Golden Model (Spike) Configuration ----------
export GOLDEN_MODE="live"               # live | off | batch | replay
export STOP_ON_SPIKE_DONE="1"           # Exit when Spike completes (1=yes, 0=no)

# ---------- RISC-V Toolchain Paths ----------
export SPIKE_BIN="/opt/riscv/bin/spike"
export SPIKE_ISA="rv32im"
export OBJDUMP_BIN="/opt/riscv/bin/riscv32-unknown-elf-objdump"
export LD_BIN="/opt/riscv/bin/riscv32-unknown-elf-ld"

# ---------- Memory Map (loaded from tools/memory_config.mk) ----------
# These are set by run.sh from the centralized config file
# export RAM_BASE="0x80040000"
# export RAM_SIZE="0x00040000"
# export PROGADDR_RESET="0x80000000"
# export PROGADDR_IRQ="0x80000100"
# export STACK_ADDR="0x8007FFF0"
# export TOHOST_ADDR="0x80001000"

# ---------- Execution Backend ----------
export EXEC_BACKEND="verilator"         # verilator | fpga (currently only verilator supported)

# ---------- Trace and Logging ----------
export TRACE_MODE="on"                  # on | off - Enable per-commit trace writing

# All runtime logging (mutator + harness) goes to: workdir/logs/runtime.log
# This includes INFO/WARN/ERROR messages and function traces (when DEBUG=1).
# AFL++ stdout/stderr remain clean for the fuzzer UI.

# ---------- Exit Stub Configuration ----------
export APPEND_EXIT_STUB="1"             # Append exit stub to programs (1=yes, 0=no)

# ---------- AFL++ Configuration ----------
export AFL_SKIP_CPUFREQ="1"             # Skip CPU frequency check
export AFL_I_DONT_CARE_ABOUT_MISSING_CRASHES="1"  # Ignore core_pattern warnings

# ---------- Notes ----------
# - CRASH_LOG_DIR, TRACE_DIR, SPIKE_LOG_FILE, LINKER_SCRIPT
#   are set automatically by run.sh based on the run directory
# - Memory configuration (RAM_BASE, etc.) is loaded from tools/memory_config.mk
# - All runtime logs go to: workdir/logs/runtime.log
# - Modify this file to customize fuzzer behavior without editing run.sh
# =============================================================================
